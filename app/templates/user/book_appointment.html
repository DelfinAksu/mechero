{% extends 'layout/base_user.html' %}
{% block content %}
<div class="form-map-container">

  <div class="register-form">
      <h2 class="form-title">Yeni Randevu Al</h2>
      <form method="POST">
          <div class="form-field">
            <label>Şehir:</label>
            <select name="city_id" onchange="this.form.submit()" required>
              <option value="" disabled {% if not selected_city_id %}selected{% endif %}>Şehir Seç</option>
              {% for city in cities %}
                <option value="{{ city.city_id }}" {% if selected_city_id and city.city_id == selected_city_id|int %}selected{% endif %}>
                  {{ city.city_name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-field">
            <label>Bayi:</label>
            <select name="dealership_id" required>
              <option value="" disabled selected>Bayi Seç</option>
              {% for d in dealerships %}
                <option value="{{ d.dealership_id }}" {% if selected_dealership_id and d.dealership_id == selected_dealership_id|int %}selected{% endif %}>
                  {{ d.d_name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-field">
            <label>Tarih:</label>
            <input type="date" name="date" required>
          </div>

          <div class="form-field">
            <label>Saat:</label>
            <input type="time" name="time" required>
          </div>

          <div class="form-field">
            <label>Bakım Türü:</label>
            <select name="type_id" required>
              <option value="" disabled selected>Bakım Türü Seç</option>
              {% for t in maintenance_types %}
                <option value="{{ t.type_id }}">{{ t.type_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-field">
            <label>Araç:</label>
            <select name="vehicle_id" required>
              <option value="" disabled selected>Araç Seç</option>
              {% for v in vehicles %}
                <option value="{{ v.vehicle_id }}">{{ v.brand }} {{ v.model }}</option>
              {% endfor %}
            </select>
          </div>

          <input type="submit" value="Kaydet">
      </form>
  </div>

  <div id="appointment-map"></div>

</div>

<!-- Leaflet CSS ve JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="dealership-data" data-json='{{ dealerships_json | tojson | safe }}'></div>

<script>
  const jsonData = document.getElementById('dealership-data').getAttribute('data-json');
  const dealershipData = JSON.parse(jsonData);

  var map = L.map('appointment-map').setView([39.0, 35.0], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
  }).addTo(map);

  dealershipData.forEach(d => {
      if (d.latitude && d.longitude) {
          L.marker([d.latitude, d.longitude])
              .addTo(map)
              .bindPopup(`<strong>${d.name}</strong><br>${d.street} No:${d.number}`);
      }
  });
</script>
<!--
<h2>Yeni Randevu Al</h2>
<form method="POST">
  Şehir:
  <select name="city_id" id="city" onchange="this.form.submit()">
    <option value="">Şehir Seç</option>
    {% for city in cities %}
      <option value="{{ city.id }}" {% if selected_city_id and city.id == selected_city_id|int %}selected{% endif %}>
        {{ city.name }}
      </option>
    {% endfor %}
  </select><br>

  Bayi:
  <select name="dealership_id">
    <option value="">Bayi Seç</option>
    {% for d in dealerships %}
      <option value="{{ d.id }}" {% if selected_dealership_id and d.id == selected_dealership_id|int %}selected{% endif %}>
        {{ d.name }} ({{ d.city.name }})
      </option>
    {% endfor %}
  </select><br>
  Tarih: <input type="date" name="date"><br>
  Saat: <input type="time" name="time"><br>
  Araç:
  <select name="vehicle_id">
    {% for v in vehicles %}
      <option value="{{ v.id }}">{{ v.brand }} {{ v.model }}</option>
    {% endfor %}
  </select><br>
  <button type="submit">Kaydet</button>
</form>



Harita Kutusu 
<div id="map" style="height: 400px; margin-top: 20px;"></div>

Leaflet CSS ve JS 
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

JSON veriyi taşıyan gizli div 
 <div id="dealership-data" data-json='{{ dealerships_json | tojson | safe }}'></div>

Marker JS 
<script>
  const jsonData = document.getElementById('dealership-data').getAttribute('data-json');
    const dealershipData = JSON.parse(jsonData);
    
    var map = L.map('map').setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    dealershipData.forEach(d => {
      if (d.latitude && d.longitude) {
        L.marker([d.latitude, d.longitude])
          .addTo(map)
          .bindPopup(`<strong>${d.name}</strong><br>${d.street} No:${d.number}`);
      }
    });
</script>
-->

{% endblock %}
